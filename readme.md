# Информация
Приложение отслеживания и изменения баланса пользователей

# Стек
- `python 3.7+`
- `poetry` - пакетный манеджер
- `flask` - основной фреймворк
- `marshmallow` - сериализация + валидация
- `sqlalchemy` - orm
- `psycopg2` - драйвер для postgres
- `huey` - очередь задач для выполнения фоновых задач (`redis` в качестве бекенда)
- `pytest` - тестовый фреймворк
- `pylint + black + unify` - линтер и форматтеры кода
- `invoke` - исполнение часто выполняемых консольных комманд

# API
- `GET api/ping` - получение состояния сервиса
- `GET api/status/26c940a1-7228-4ea2-a3bc-e6460b172040` - получение информации о абоненте
- `POST api/substract {"id": "<uuid-v4>", "amount": "33.48"}` - уменишение баланса пользователя
- `POST api/add {"id": "<uuid-v4>", "amount": "33.48"}` - пополнение баланса пользователя

# Основные комманды
- `inv run` - запуск сервера
- `inv lint` - запуск линтеров
- `inv pretty` - запуск форматтеров кода
- `inv install-fixture <fixture-name>` - заливка подготовленных данных в базу
- `pytest --create-db` - запуск тестов (`--create-db для пересоздания схемы и тестовых данных`)

# Структура кода
- `migrations` - папка с alembic миграциями базы
- `docker` - папка с настройками дял запуска приложения в докере
- `app` - код приложения
    - `configs` - настройки приложения
    - `fixtures` - подготовленные данные для изначального заполнения базы
    - `message_queue` - настройки воркеров для `huey`
    - `utils` - утилиты
    - `__init__.py` - настройка flask приложения
    - `main` - основной блюпринт с кодом
        - `models` - модели для базы
        - `schemas` - модели сериализации и десериализации
        - `tests` - тесты
        - `views` - обработчики запросов
        - `urls` - определения урлов
        
# Запуск
## Локально
необходимо создать локальный `.env` файл с настройками (пример в `.env.example`)

```bash
$ python -m venv .venv
$ . .venv/bin/activate
$ pip install poetry
$ poetry install
$ inv run
```

## В докере
```bash
$ sudo chmod +x ./deploy.sh
$ PORT=8080 DB_PASSWORD=123 APP_SECRET_KEY=123 ./deploy.sh
```

# Сервисы в докере
- `nginx` - reverse proxy для приложения
- `app` - сервер с приложением (`gunicorn` в качестве wsgi сервера)
- `redis` - in-memory бд, использующаяся в качестве брокера для очереди сообщений
- `huey_worker` - очередь сообщений
- `postgres` - основная база данных приложения

# Переменные окружения
- `FLASK_ENV` - окружение flask (development / production)
- `SUBSTRACT_HOLD_PERIOD` - период в минутах, через который холды списываются со счёта абонентов
- `HUEY_WORKERS` - количество воркеров в очереди сообщений
- `JSON_AS_ASCII` - нужно ли эскейпить unicode в ответах
- `SQLALCHEMY_ECHO` - включение логгирования запросов в базу
- `DB_USER` - имя пользователя в основной бд
- `DB_PASSWORD` - пароль в основной бд
- `DB_HOST` - хост основной бд
- `DB_NAME` - название основной бд
- `TEST_DB_USER` - имя пользователя в тестовой бд
- `TEST_DB_PASSWORD` - пароль в тестовой бд
- `TEST_DB_HOST` - хост тестовой бд
- `TEST_DB_NAME` - название тестовой бд
